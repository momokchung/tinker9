OUTPUT_DIR: src/cu/solv
KERNEL_NAME: ediff_cu1
TEMPLATE_PARAMS: template<class Ver>
CONSTEXPR_FLAGS: |
  constexpr bool do_e = Ver::e;
  constexpr bool do_a = Ver::a;
  constexpr bool do_g = Ver::g;

# COUNT:
#   - nes
ENERGY:
  - es
GRADIENT:
  - gx
  - gy
  - gz

# CUT_DISTANCE:
OFF_DISTANCE: 'off'

EXCLUDE_INFO: mdpuinfo
SCALE_1X_TYPE: real4_const_array,1,2,3

EXTRA_PARAMS: |
  , const real (*restrict rpole)[10]
  , const real (*restrict uind)[3], const real (*restrict uinds)[3]
  , real f
IMPLICIT_PARAMS:
  - d::jpolar
  - d::njpolar
  - d::pdamp
  - d::thlval

I_VARIABLES:
  - shared real xi    from:x
  - shared real yi    from:y
  - shared real zi    from:z
  - shared real ci    from:rpole,MPL_PME_0
  - shared real dix   from:rpole,MPL_PME_X
  - shared real diy   from:rpole,MPL_PME_Y
  - shared real diz   from:rpole,MPL_PME_Z
  - shared real qixx  from:rpole,MPL_PME_XX
  - shared real qixy  from:rpole,MPL_PME_XY
  - shared real qixz  from:rpole,MPL_PME_XZ
  - shared real qiyy  from:rpole,MPL_PME_YY
  - shared real qiyz  from:rpole,MPL_PME_YZ
  - shared real qizz  from:rpole,MPL_PME_ZZ
  - shared real uidx  from:uind,0
  - shared real uidy  from:uind,1
  - shared real uidz  from:uind,2
  - shared real uidsx from:uinds,0
  - shared real uidsy from:uinds,1
  - shared real uidsz from:uinds,2
  - shared real pdi   from:pdamp
  - shared int  jpi   from:jpolar
K_VARIABLES:
  - shared   real xk    from:x
  - shared   real yk    from:y
  - shared   real zk    from:z
  - register real ck    from:rpole,MPL_PME_0
  - shared   real dkx   from:rpole,MPL_PME_X
  - shared   real dky   from:rpole,MPL_PME_Y
  - shared   real dkz   from:rpole,MPL_PME_Z
  - register real qkxx  from:rpole,MPL_PME_XX
  - register real qkxy  from:rpole,MPL_PME_XY
  - register real qkxz  from:rpole,MPL_PME_XZ
  - register real qkyy  from:rpole,MPL_PME_YY
  - register real qkyz  from:rpole,MPL_PME_YZ
  - register real qkzz  from:rpole,MPL_PME_ZZ
  - shared   real ukdx  from:uind,0
  - shared   real ukdy  from:uind,1
  - shared   real ukdz  from:uind,2
  - shared   real ukdsx from:uinds,0
  - shared   real ukdsy from:uinds,1
  - shared   real ukdsz from:uinds,2
  - register real pdk   from:pdamp
  - register int  jpk   from:jpolar
I_FORCE:
  - register real frcxi   addto:gx
  - register real frcyi   addto:gy
  - register real frczi   addto:gz
  # - register real trqxi addto:trqx
  # - register real trqyi addto:trqy
  # - register real trqzi addto:trqz
K_FORCE:
  - register real frcxk   addto:gx
  - register real frcyk   addto:gy
  - register real frczk   addto:gz
  # - register real trqxk addto:trqx
  # - register real trqyk addto:trqy
  # - register real trqzk addto:trqz

SCALED_PAIRWISE_INTERACTION: |
  real xr = @xk@ - @xi@;
  real yr = @yk@ - @yi@;
  real zr = @zk@ - @zi@;
  real r2 = xr*xr + yr*yr + zr*zr;
  if (r2 <= off * off and incl) {
    real pga = thlval[njpolar * jpi[klane] + jpk];
    real e;
    pair_ediff<Ver>(
      r2, xr, yr, zr, scaleb, scalec, scaled, //
      @ci@, @dix@, @diy@, @diz@, @qixx@, @qixy@, @qixz@, @qiyy@, @qiyz@, @qizz@,
      @uidx@, @uidy@, @uidz@,
      @uidsx@, @uidsy@, @uidsz@, @pdi@, pga, //
      @ck@, @dkx@, @dky@, @dkz@, @qkxx@, @qkxy@, @qkxz@, @qkyy@, @qkyz@, @qkzz@,
      @ukdx@, @ukdy@, @ukdz@,
      @ukdsx@, @ukdsy@, @ukdsz@, @pdk@, pga, //
      f, e);
    if CONSTEXPR (do_e) {
      estl += floatTo<ebuf_prec>(e);
    }
  } // end if (include)
FULL_PAIRWISE_INTERACTION: |
  real xr = @xk@ - @xi@;
  real yr = @yk@ - @yi@;
  real zr = @zk@ - @zi@;
  real r2 = xr*xr + yr*yr + zr*zr;
  if (r2 <= off * off and incl) {
    real pga = thlval[njpolar * jpi[klane] + jpk];
    real e;
    pair_ediff<Ver>(
      r2, xr, yr, zr, 1, 1, 1, //
      @ci@, @dix@, @diy@, @diz@, @qixx@, @qixy@, @qixz@, @qiyy@, @qiyz@, @qizz@,
      @uidx@, @uidy@, @uidz@,
      @uidsx@, @uidsy@, @uidsz@, @pdi@, pga, //
      @ck@, @dkx@, @dky@, @dkz@, @qkxx@, @qkxy@, @qkxz@, @qkyy@, @qkyz@, @qkzz@,
      @ukdx@, @ukdy@, @ukdz@,
      @ukdsx@, @ukdsy@, @ukdsz@, @pdk@, pga, //
      f, e);
    if CONSTEXPR (do_e) {
      estl += floatTo<ebuf_prec>(e);
    }
  } // end if (include)
