OUTPUT_DIR: src/cu/solv
KERNEL_NAME: ewcaN2_cu1
TEMPLATE_PARAMS: template <class Ver>
CONSTEXPR_FLAGS: |
  constexpr bool do_e = Ver::e;
  constexpr bool do_g = Ver::g;
USE_NEIGH: False

# COUNT:
#   - ns
ENERGY:
  - es
GRADIENT:
  - gx
  - gy
  - gz

EXTRA_PARAMS: |
  , const real* restrict epsdsp
  , const real* restrict raddsp
  , real epso, real epsh
  , real rmino, real rminh
  , real shctd, real dspoff
  , real slevy, real awater
# IMPLICIT_PARAMS:

I_VARIABLES:
  - shared real xi    from:x
  - shared real yi    from:y
  - shared real zi    from:z
  - shared real epsli from:epsdsp
  - shared real rmini from:raddsp
K_VARIABLES:
  - shared   real xk    from:x
  - shared   real yk    from:y
  - shared   real zk    from:z
  - register real epslk from:epsdsp
  - register real rmink from:raddsp
I_FORCE:
  - register real gxi addto:gx
  - register real gyi addto:gy
  - register real gzi addto:gz
K_FORCE:
  - register real gxk addto:gx
  - register real gyk addto:gy
  - register real gzk addto:gz

#SCALED_PAIRWISE_INTERACTION: |
FULL_PAIRWISE_INTERACTION: |
  real xr = @xk@ - @xi@;
  real yr = @yk@ - @yi@;
  real zr = @zk@ - @zi@;
  real r2 = xr*xr + yr*yr + zr*zr;
  real e;
  
  if (incl) {
    real r = REAL_SQRT(r2);
    real r3 = r2 * r;
    real epsi = @epsli@;
    real rmin = @rmini@;
    real epsosqrt = REAL_SQRT(epso);
    real epsisqrt = REAL_SQRT(epsi);
    real term1 = epsosqrt + epsisqrt;
    real term12 = term1*term1;
    real rmino2 = rmino*rmino;
    real rmino3 = rmino2*rmino;
    real rmin2 = rmin*rmin;
    real rmin3 = rmin2*rmin;
    real emixo = 4. * epso * epsi / term12;
    real rmixo = 2. * (rmino3+rmin3) / (rmino2+rmin2);
    real rmixo7 = REAL_POW(rmixo,7);
    real aoi = emixo * rmixo7;
    real epshsqrt = REAL_SQRT(epsh);
    real term2 = epshsqrt + epsisqrt;
    real term22 = term2*term2;
    real rminh2 = rminh*rminh;
    real rminh3 = rminh2*rminh;
    real emixh = 4. * epsh * epsi / term22;
    real rmixh = 2. * (rminh3+rmin3) / (rminh2+rmin2);
    real rmixh7 = REAL_POW(rmixh,7);
    real ahi = emixh * rmixh7;
    real rio = rmixo / 2. + dspoff;
    real rih = rmixh / 2. + dspoff;
    real si = rmin * shctd;
    real si2 = si * si;

    real epsk = @epslk@;
    real rmkn = @rmink@;
    real epsksqrt = REAL_SQRT(epsk);
    real term3 = epsosqrt+epsksqrt;
    real term32 = term3*term3;
    real emkxo = 4. * epso * epsk / term32;
    real rmkn2 = rmkn*rmkn;
    real rmkn3 = rmkn2*rmkn;
    real rmkxo = 2. * (rmino3+rmkn3) / (rmino2+rmkn2);
    real rmkxo7 = REAL_POW(rmkxo,7);
    real aok = emkxo * rmkxo7;
    real term4 = epshsqrt+epsksqrt;
    real term42 = term4*term4;
    real emkxh = 4. * epsh * epsk / term42;
    real rmkxh = 2. * (rminh3+rmkn3) / (rminh2+rmkn2);
    real rmkxh7 = REAL_POW(rmkxh,7);
    real ahk = emkxh * rmkxh7;
    real rko = rmkxo / 2. + dspoff;
    real rkh = rmkxh / 2. + dspoff;
    real sk = rmkn * shctd;
    real sk2 = sk * sk;
    
    real sum1,sum2;
    real de,de1,de2;
    real de11,de12,de21,de22;

    pair_ewca<Ver>(
      r, r2, r3, rio, rmixo, rmixo7,
      sk, sk2, aoi, emixo, sum1, de11, true);
    pair_ewca<Ver>(
      r, r2, r3, rih, rmixh, rmixh7,
      sk, sk2, ahi, emixh, sum2, de12, false);
    e = sum1 + sum2;
    
    pair_ewca<Ver>(
      r, r2, r3, rko, rmkxo, rmkxo7,
      si, si2, aok, emkxo, sum1, de21, true);
    pair_ewca<Ver>(
      r, r2, r3, rkh, rmkxh, rmkxh7,
      si, si2, ahk, emkxh, sum2, de22, false);
    e += sum1 + sum2;

    real slwater = slevy * awater;
    e *= -slwater;

    if CONSTEXPR (do_e)
      estl += floatTo<ebuf_prec>(e);
    if CONSTEXPR (do_g) {
      de1 = de11 + de12;
      de2 = de21 + de22;
      de = de1 + de2;
      de *= slwater / r;
      real dedx = de * xr;
      real dedy = de * yr;
      real dedz = de * zr;
      @gxi@ += dedx;
      @gyi@ += dedy;
      @gzi@ += dedz;
      @gxk@ -= dedx;
      @gyk@ -= dedy;
      @gzk@ -= dedz;
    }
  } // end if (include)
