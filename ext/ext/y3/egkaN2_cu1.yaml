OUTPUT_DIR: src/cu/solv
KERNEL_NAME: egkaN2_cu1
TEMPLATE_PARAMS: template<class Ver>
CONSTEXPR_FLAGS: |
  constexpr bool do_a = Ver::a;
  constexpr bool do_e = Ver::e;
  constexpr bool do_g = Ver::g;
USE_NEIGH: False

COUNT:
  - nes
ENERGY:
  - es
GRADIENT:
  - gx
  - gy
  - gz

# CUT_DISTANCE:
OFF_DISTANCE: 'off'

EXTRA_PARAMS: |
  , real *restrict trqx
  , real *restrict trqy
  , real *restrict trqz
  , real *restrict drb
  , real *restrict drbp
  , const real* restrict rborn
  , const real (*restrict rpole)[10]
  , const real (*restrict uinds)[3]
  , const real (*restrict uinps)[3]
  , real gkc, real fc, real fd, real fq
# IMPLICIT_PARAMS:

I_VARIABLES:
  - shared real xi   from:x
  - shared real yi   from:y
  - shared real zi   from:z
  - shared real ci   from:rpole,MPL_PME_0
  - shared real dix  from:rpole,MPL_PME_X
  - shared real diy  from:rpole,MPL_PME_Y
  - shared real diz  from:rpole,MPL_PME_Z
  - shared real qixx from:rpole,MPL_PME_XX
  - shared real qixy from:rpole,MPL_PME_XY
  - shared real qixz from:rpole,MPL_PME_XZ
  - shared real qiyy from:rpole,MPL_PME_YY
  - shared real qiyz from:rpole,MPL_PME_YZ
  - shared real qizz from:rpole,MPL_PME_ZZ
  - shared real uidx from:uinds,0
  - shared real uidy from:uinds,1
  - shared real uidz from:uinds,2
  - shared real uipx from:uinps,0
  - shared real uipy from:uinps,1
  - shared real uipz from:uinps,2
  - shared real rbi  from:rborn
K_VARIABLES:
  - shared   real xk   from:x
  - shared   real yk   from:y
  - shared   real zk   from:z
  - register real ck   from:rpole,MPL_PME_0
  - shared   real dkx  from:rpole,MPL_PME_X
  - shared   real dky  from:rpole,MPL_PME_Y
  - shared   real dkz  from:rpole,MPL_PME_Z
  - register real qkxx from:rpole,MPL_PME_XX
  - register real qkxy from:rpole,MPL_PME_XY
  - register real qkxz from:rpole,MPL_PME_XZ
  - register real qkyy from:rpole,MPL_PME_YY
  - register real qkyz from:rpole,MPL_PME_YZ
  - register real qkzz from:rpole,MPL_PME_ZZ
  - shared   real ukdx from:uinds,0
  - shared   real ukdy from:uinds,1
  - shared   real ukdz from:uinds,2
  - shared   real ukpx from:uinps,0
  - shared   real ukpy from:uinps,1
  - shared   real ukpz from:uinps,2
  - register real rbk  from:rborn
I_FORCE:
  - register real gxi  addto:gx
  - register real gyi  addto:gy
  - register real gzi  addto:gz
  - register real txi  addto:trqx
  - register real tyi  addto:trqy
  - register real tzi  addto:trqz
  - register real drbi addto:drb
  - register real dpbi addto:drbp
K_FORCE:
  - register real gxk  addto:gx
  - register real gyk  addto:gy
  - register real gzk  addto:gz
  - register real txk  addto:trqx
  - register real tyk  addto:trqy
  - register real tzk  addto:trqz
  - register real drbk addto:drb
  - register real dpbk addto:drbp

#SCALED_PAIRWISE_INTERACTION: |
FULL_PAIRWISE_INTERACTION: |
  real xr = @xk@ - @xi@;
  real yr = @yk@ - @yi@;
  real zr = @zk@ - @zi@;
  real xr2 = xr*xr;
  real yr2 = yr*yr;
  real zr2 = zr*zr;
  real r2 = xr2 + yr2 + zr2;
  if (r2 <= off * off and incl) {
    real e;
    PairSolvGrad pgrad;
    zero(pgrad);

    real tdrbi,tdpbi,tdrbk,tdpbk;
    real dedx,dedy,dedz;

    pair_egka<Ver>(
      r2, xr, yr, zr, xr2, yr2, zr2,
      @ci@, @dix@, @diy@, @diz@, @qixx@, @qixy@, @qixz@, @qiyy@, @qiyz@, @qizz@,
      @uidx@, @uidy@, @uidz@, @uipx@, @uipy@, @uipz@, @rbi@,
      @ck@, @dkx@, @dky@, @dkz@, @qkxx@, @qkxy@, @qkxz@, @qkyy@, @qkyz@, @qkzz@,
      @ukdx@, @ukdy@, @ukdz@, @ukpx@, @ukpy@, @ukpz@, @rbk@,
      gkc, fc, fd, fq, e, pgrad, dedx, dedy, dedz, tdrbi, tdpbi, tdrbk, tdpbk);
    if CONSTEXPR (do_e) {
      estl += floatTo<ebuf_prec>(e);
      if CONSTEXPR (do_a) {
        nestl += 1;
      }
    }
    if CONSTEXPR (do_g) {
      @gxi@ += pgrad.frcx;
      @gyi@ += pgrad.frcy;
      @gzi@ += pgrad.frcz;
      @gxk@ -= pgrad.frcx;
      @gyk@ -= pgrad.frcy;
      @gzk@ -= pgrad.frcz;

      @txi@ += pgrad.ttqi[0];
      @tyi@ += pgrad.ttqi[1];
      @tzi@ += pgrad.ttqi[2];
      @txk@ += pgrad.ttqk[0];
      @tyk@ += pgrad.ttqk[1];
      @tzk@ += pgrad.ttqk[2];

      @drbi@ += tdrbi;
      @drbk@ += tdrbk;
      @dpbi@ += tdpbi;
      @dpbk@ += tdpbk;
    }
  } // end if (include)
